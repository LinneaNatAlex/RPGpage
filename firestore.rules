rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // USERS - hver bruker får tilgang til sitt eget dokument,
    // men alle kan oppdatere inventory-feltet til andre brukere (for gaver)
    // VIP system kan oppdatere VIP-relaterte felter
    // Alle kan lese brukerdata for statistikk (ikke-innloggede brukere)
    match /users/{userId} {
      allow read: if true;
      allow update: if request.auth != null && (
        // Admin eller professor kan oppdatere alle brukere (inkl. fjerne felter som age)
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny(["admin", "professor", "teacher"]) ||
        // Vanlig bruker kan oppdatere seg selv
        request.auth.uid == userId ||
        // Location tracking: brukere kan oppdatere sin egen currentLocation og lastSeen
        (
          request.auth.uid == userId &&
          request.resource.data.diff(resource.data).changedKeys().hasOnly(['currentLocation', 'lastSeen'])
        ) ||
        (
          // Kun inventory kan endres av andre brukere (for gaver)
          request.resource.data.keys().hasAll(resource.data.keys()) &&
          resource.data.keys().hasAll(request.resource.data.keys()) &&
          (
            request.resource.data.inventory != resource.data.inventory &&
            request.resource.data.diff(resource.data).changedKeys().hasOnly(['inventory'])
          )
        ) ||
        // Admin og professor kan oppdatere inventory for alle brukere (for bok-oppdateringer)
        (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny(["admin", "professor", "teacher"]) &&
          request.resource.data.diff(resource.data).changedKeys().hasOnly(['inventory'])
        ) ||
        // VIP system kan oppdatere VIP-relaterte felter for egen bruker
        (
          request.auth.uid == userId &&
          request.resource.data.diff(resource.data).changedKeys().hasAny(['roles', 'vipExpiresAt', 'vipActivatedAt', 'vipTheme', 'vipSettings']) &&
          // Sikre at bare VIP-relaterte felter endres
          request.resource.data.diff(resource.data).changedKeys().hasOnly(['roles', 'vipExpiresAt', 'vipActivatedAt', 'vipTheme', 'vipSettings', 'inventory', 'lastActive', 'currency', 'points', 'health', 'currentLocation', 'lastSeen']) &&
          // Sikre at VIP rolle bare kan legges til eller fjernes, ikke andre roller
          (
            !request.resource.data.diff(resource.data).changedKeys().hasAny(['roles']) ||
            (
              request.resource.data.roles is list &&
              (resource.data.roles is list || resource.data.roles == null) &&
              (
                // Legger til VIP rolle
                (resource.data.roles == null && request.resource.data.roles == ['vip']) ||
                (resource.data.roles is list && 
                 request.resource.data.roles.hasAll(resource.data.roles) && 
                 request.resource.data.roles.removeAll(resource.data.roles).hasOnly(['vip'])) ||
                // Fjerner VIP rolle
                (resource.data.roles is list && 
                 resource.data.roles.hasAll(request.resource.data.roles) && 
                 resource.data.roles.removeAll(request.resource.data.roles).hasOnly(['vip'])) ||
                // Beholder samme roller (for andre oppdateringer)
                request.resource.data.roles == resource.data.roles
              )
            )
          )
        ) ||
        // Pet interactions: alle kan interagere med andres kjæledyr
        (
          request.auth != null &&
          request.resource.data.diff(resource.data).changedKeys().hasOnly(['currentPet']) &&
          request.resource.data.currentPet.diff(resource.data.currentPet).changedKeys().hasOnly(['mood', 'lastPet', 'lastPlay', 'lastInteractionBy', 'lastInteractionType'])
        ) ||
        // Profile likes: alle innloggede kan oppdatere profileLikedBy på andre brukere (for å like profiler)
        (
          request.auth != null &&
          request.resource.data.diff(resource.data).changedKeys().hasOnly(['profileLikedBy'])
        )
      );
      allow create, delete: if request.auth != null && request.auth.uid == userId;
      
      // PURCHASES - brukere kan skrive til sin egen purchases subcollection
      match /purchases/{purchaseId} {
        allow create: if request.auth != null && request.auth.uid == userId;
      }
      
      // CONSUMPTIONS - brukere kan skrive til sin egen consumptions subcollection
      match /consumptions/{consumptionId} {
        allow create: if request.auth != null && request.auth.uid == userId;
      }
    }

    // USERCHATS - hver bruker får tilgang til sitt eget dokument
    match /userChats/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // MESSAGES (main chat) - any logged-in user can read and post
    match /messages/{messageId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null;
    }

    // PRIVATE MESSAGES - de to brukerne kan lese/skrive; admin kan liste alle chatter og slette alle meldinger (Clear all)
    match /privateMessages/{chatId} {
      allow read: if request.auth != null && (
        request.auth.uid in chatId.split('_') ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get("roles", []).hasAny(["admin"])
      );
      match /messages/{messageId} {
        allow read, create, update: if request.auth != null && request.auth.uid in chatId.split('_');
        allow delete: if request.auth != null && (
          request.auth.uid in chatId.split('_') ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get("roles", []).hasAny(["admin"])
        );
      }
    }

    // GROUP CHATS - innlogget bruker kan lese/opprette grupper; medlemmer kan oppdatere (f.eks. leave); kun oppretter kan slette
    match /groupChats/{groupId} {
      allow read, create: if request.auth != null;
      allow update: if request.auth != null && resource.data.keys().hasAny(["members"]) && request.auth.uid in resource.data.members;
      allow delete: if request.auth != null
        && (resource.data.createdBy == request.auth.uid
            || (!("createdBy" in resource.data) && resource.data.members.size() > 0 && resource.data.members[0] == request.auth.uid));
      match /messages/{messageId} {
        allow read, create: if request.auth != null;
        allow update, delete: if request.auth != null;
      }
    }

    // RPGGRATEHALL (Starshade Hall) - alle innloggede kan lese og poste meldinger; admin/professor kan slette
    match /rpgGrateHall/{docId} {
      allow read, create: if request.auth != null;
      allow update, delete: if request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get("roles", []).hasAny(["admin", "professor", "teacher"]));
    }

    // NEWS - alle kan lese; alle kan oppdatere (f.eks. likedBy); bare admin/professor kan opprette/slette
    match /news/{docId} {
      allow read: if request.auth != null;
      allow create, delete: if request.auth != null &&
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny(["admin", "professor", "teacher"]));
      allow update: if request.auth != null;
    }

    // ANNOUNCEMENTS - alle kan lese, bare admin og professor kan opprette, endre og slette
    match /announcements/{docId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null &&
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny(["admin", "professor", "teacher"]));
    }

    // SHOPITEMS - alle kan lese, bare admin og professor kan opprette, endre og slette
    match /shopItems/{docId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null &&
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny(["admin", "professor", "teacher"]));
    }
    
    // BOOKS - alle innloggede brukere kan lese og skrive (midlertidig)
    match /books/{docId} {
      allow read, write: if request.auth != null;
    }

    // CLASS DESCRIPTIONS - alle kan lese, bare admin og professor kan redigere
    match /classDescriptions/{classId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null; // Temporarily allow all authenticated users for testing
    }

    // QUIZZES - alle kan lese, bare professor og admin kan opprette/redigere
    match /quizzes/{quizId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null; // Temporarily allow all authenticated users for testing
    }

    // QUIZ RESULTS - brukere kan lese sine egne resultater, professor og admin kan lese alle
    match /quizResults/{resultId} {
      allow read: if request.auth != null && (
        // Bruker kan lese sine egne resultater (resultId starts with user ID)
        resultId.matches(request.auth.uid + '_.*') ||
        // Professor og admin kan lese alle resultater
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny(["admin", "professor", "teacher"]))
      );
      allow create: if request.auth != null && resultId.matches(request.auth.uid + '_.*');
      allow update: if request.auth != null && (
        // Bruker kan oppdatere sine egne resultater
        resultId.matches(request.auth.uid + '_.*') ||
        // Professor og admin kan oppdatere alle resultater
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny(["admin", "professor", "teacher"]))
      );
    }

    // CLASS ATTENDANCE - alle innloggede kan lese og skrive (for å delta i klasser)
    match /classAttendance/{docId} {
      allow read, write: if request.auth != null;
    }

    // FORUM - innloggede brukere kan lese og skrive i alle forum
    match /forums/{forumRoom}/posts/{postId} {
      allow read, write: if request.auth != null;
    }
    
    // FORUM TOPICS - innloggede brukere kan lese og skrive topics og posts i topics
    match /forums/{forumRoom}/topics/{topicId} {
      allow read, write: if request.auth != null;
      // Nested posts in topics
      match /posts/{postId} {
        allow read, write: if request.auth != null;
      }
    }
    
    // CLASS CHATS - alle innloggede kan lese og skrive
    match /classChats/{chatId} {
      allow read, write: if request.auth != null;
    }

    // ALDERSVERIFISERING - alle innloggede brukere kan sende forespørsel, admin kan lese
    match /ageVerificationRequests/{docId} {
      allow read, write: if request.auth != null;
    }

    // NOTIFICATIONS - brukere kan lese/oppdatere/slette sine egne; alle kan lage notifikasjoner der de er avsender (til andre)
    match /notifications/{notificationId} {
      allow read: if request.auth != null && resource.data.to == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.from == request.auth.uid;
      allow update, delete: if request.auth != null && resource.data.to == request.auth.uid;
    }

    // CONFIG (f.eks. sidetema, segment-oppgaver) - alle kan lese; admin kan skrive alt; lærer med leadForRole kan skrive sitt segment
    match /config/{docId} {
      allow read: if true;
      allow write: if request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get("roles", []).hasAny(["admin"]) ||
          (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get("roles", []).hasAny(["professor", "teacher"]) &&
           get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get("leadForRole", "") == "archivist" &&
           docId == "segmentArchivist") ||
          (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get("roles", []).hasAny(["professor", "teacher"]) &&
           get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get("leadForRole", "") == "shadowpatrol" &&
           docId == "segmentShadowpatrol")
        );
    }

    // PAGE RULES (admin/professor/headmaster can edit rules for each rules page)
    match /pageRules/{slug} {
      allow read: if true;
      allow create, update, delete: if request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get("roles", []).hasAny(["admin", "professor", "teacher", "headmaster"]);
    }

    // Library (tips): archivist, professor, headmaster, admin (any casing)
    match /library/{docId} {
      allow read: if true;
      allow create, update, delete: if request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get("roles", []).hasAny(["admin", "headmaster", "professor", "teacher", "archivist", "Admin", "Headmaster", "Professor", "Teacher", "Archivist"]);
    }
  }
}